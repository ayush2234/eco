image: node:16

# Workflow Configuration

pipelines:
  default:
    - parallel:
      - step:
          name: Build and Test
          caches:
            - node
          script:
            - npm install
            #- npm test
            - npm run build
            - mkdir artifact
            - (cd dist/ecommify; zip -r ../../artifact/ng-app-dist.zip .)
          artifacts:
            - artifact/ng-app-dist.zip
            - dist/ecommify/**
      - step:
          name: Security Scan
          script:
            # Run a security scan for sensitive data.
            # See more security tools at https://bitbucket.org/product/features/pipelines/integrations?&category=security
            - pipe: atlassian/git-secrets-scan:0.5.1
    - step:
        name: Upload to S3
        deployment: Production
        trigger: manual
        clone:
          enabled: false
        script:
          # sync your files to S3
          - pipe: atlassian/aws-s3-deploy:1.1.0
            variables:
              AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
              AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
              AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION
              S3_BUCKET: 'ecommify/frontend-app-dist'
              LOCAL_PATH: 'artifact'
    - step:
        name: Deploy to EC2
        deployment: Production
        trigger: manual
        clone:
          enabled: false
        script:
          - pipe: atlassian/scp-deploy:1.2.1
            variables:
              USER: 'bitbucket'
              SERVER: 'ec2-13-239-30-251.ap-southeast-2.compute.amazonaws.com'
              REMOTE_PATH: '/home/bitbucket/ng-app/'
              LOCAL_PATH: 'dist/ecommify/*'
